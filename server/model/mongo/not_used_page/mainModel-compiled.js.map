{"version":3,"sources":["mainModel.js"],"names":[],"mappings":";;AAAA;;;AAGA,IAAI,cAAY,QAAQ,gBAAR,CAAhB;AACA,IAAI,eAAa,YAAY,YAA7B;AACA,IAAI,WAAS,YAAY,QAAzB;AACA,IAAI,YAAU,YAAY,SAA1B;AACA,IAAI,QAAM,QAAQ,OAAR,CAAV;AACA,IAAI,kBAAgB,QAAQ,sCAAR,EAAgD,gBAApE;AACA,IAAI,gBAAc,QAAQ,kCAAR,EAA4C,IAA9D,C,CAAkE;AAClE,IAAI,gBAAc,QAAQ,oCAAR,EAA8C,aAAhE;;AAEA,IAAI,UAAQ,QAAQ,mBAAR,EAA6B,OAAzC;AACA,IAAI,aAAW,QAAQ,wCAAR,EAAkD,UAAjE;AACA,IAAI,iBAAe,QAAQ,gCAAR,EAA0C,cAA7D;AACA,IAAI,iBAAe,QAAQ,kCAAR,EAA4C,gBAA/D;AACA,IAAI,mBAAiB,QAAQ,oCAAR,EAA8C,kBAAnE;;AAEA,IAAI,mBAAiB,SAAjB,gBAAiB,CAAS,QAAT,EAAkB;AACnC;AACA,iBAAa,IAAb,CAAkB,EAAlB,EAAqB,iDAArB,EAAuE,EAAC,MAAK,EAAC,OAAM,CAAC,CAAR,EAAN,EAAiB,OAAM,QAAQ,gBAA/B,EAAvE,EAAwH,UAAS,GAAT,EAAa,aAAb,EAA2B;AAC/I,YAAG,GAAH,EAAO;AACH,0BAAc,EAAC,IAAG,IAAI,IAAR,EAAc,KAAI,IAAI,MAAtB,EAAd,EAA6C,MAA7C,EAAqD,uBAArD;AACA,mBAAO,SAAS,GAAT,EAAa,eAAe,OAAf,CAAuB,IAApC,CAAP;AACH;AACD,YAAG,MAAI,cAAc,MAArB,EAA4B;AACxB,mBAAO,SAAS,IAAT,EAAc,EAAC,IAAG,CAAJ,EAAM,KAAI,SAAV,EAAd,CAAP;AACH;AACD;AACA,YAAI,cAAY,EAAhB,CAT+I,CAS5H;AACnB,YAAI,MAAI,CAAC,EAAC,MAAK,QAAN,EAAe,OAAM,OAArB,EAA6B,QAAO,YAApC,EAAD,CAAR;AACA;AACA;AACA;AACA,cAAM,SAAN,CAAgB,aAAhB,EAA8B,UAAS,KAAT,EAAe,GAAf,EAAmB,EAAnB,EAAsB;AAChD,kBAAM,QAAN,CAAe,GAAf,EAAmB,UAAS,GAAT,EAAa,MAAb,EAAoB;AACnC,oBAAG,GAAH,EAAO;AACH,kCAAc,EAAC,IAAG,IAAI,IAAR,EAAc,KAAI,IAAI,MAAtB,EAAd,EAA6C,MAA7C,EAAqD,2BAArD;AACA,2BAAO,SAAS,GAAT,EAAa,eAAe,OAAf,CAAuB,YAApC,CAAP;AACH;AACjB;;;;;AAKgB,4BAAY,IAAZ,CAAiB,OAAO,QAAP,EAAjB;AACA;AACD;AACF,aAbD;AAcH,SAfD,EAeE,UAAS,GAAT,EAAa;AACX;AACA,mBAAO,SAAS,IAAT,EAAc,EAAC,IAAG,CAAJ,EAAM,KAAI,WAAV,EAAd,CAAP;AACH,SAlBD;AAoBH,KAlCD;AAmCH,CArCD;AAsCA,QAAQ,eAAR,GAAwB;AACpB,sBAAiB;AADG,CAAxB","file":"mainModel-compiled.js","sourcesContent":["/**\r\n * Created by zw on 2015/10/13.\r\n */\r\nvar dbStructure=require('./db_structure');\r\nvar articleModel=dbStructure.articleModel;\r\nvar keyModel=dbStructure.keyModel;\r\nvar userModel=dbStructure.userModel;\r\nvar async=require('async')\r\nvar generalFunction=require('../express_component/generalFunction').generateFunction\r\nvar miscellaneous=require('../assist_function/miscellaneous').func//可以和generalFunction合并\r\nvar errorRecorder=require('../express_component/recorderError').recorderError;\r\n\r\nvar general=require('../assist/general').general\r\nvar validateDb=require('../error_define/3rd_party_error_define').validateDb;\r\nvar input_validate=require('../error_define/input_validate').input_validate;\r\nvar runtimeDbError=require('../error_define/runtime_db_error').runtime_db_error;\r\nvar runtimeNodeError=require('../error_define/runtime_node_error').runtime_node_error;\r\n\r\nvar getLatestArticle=function(callback){\r\n    //console.log(1)\r\n    articleModel.find({},'-_id hashId mDate author title keys pureContent',{sort:{cDate:-1},limit:general.latestArticleNum},function(err,findedArticle){\r\n        if(err){\r\n            errorRecorder({rc:err.code, msg:err.errmsg}, 'main', 'getLatestArticle-find')\r\n            return callback(err,runtimeDbError.article.find)\r\n        }\r\n        if(0===findedArticle.length){\r\n            return callback(null,{rc:0,msg:undefined})   \r\n        }\r\n        //console.log(2)\r\n        var finalResult=[];//populate之后，需要toObject()以便获得正确的时间；toObject的结果需要push到一个新的变量，而不是原始mongoose doc，否则Conv date不会出现\r\n        var opt=[{path:'author',model:'users',select:'name mDate'}]\r\n        //findedArticle.populate(opt,function(err,result){\r\n        //    console.log(result)\r\n        //})\r\n        async.forEachOf(findedArticle,function(value,key,cb){\r\n            value.populate(opt,function(err,result){\r\n                if(err){\r\n                    errorRecorder({rc:err.code, msg:err.errmsg}, 'main', 'getLatestArticle-pupolate')\r\n                    return callback(err,runtimeDbError.article.populateUser)\r\n                }\r\n/*                console.log(result.author.toObject())\r\n                var author=result.author.toObject()\r\n                result.author=undefined\r\n                result.author=author\r\n                console.log(result.author)*/\r\n                finalResult.push(result.toObject())\r\n                //value=result.toObject()\r\n               cb()\r\n            })\r\n        },function(err){\r\n            //console.log(findedArticle)\r\n            return callback(null,{rc:0,msg:finalResult})\r\n        })\r\n\r\n    })\r\n}\r\nexports.mainDboperation={\r\n    getLatestArticle:getLatestArticle\r\n}\r\n"]}