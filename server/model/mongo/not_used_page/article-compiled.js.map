{"version":3,"sources":["article.js"],"names":[],"mappings":"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","file":"article-compiled.js","sourcesContent":["/**\r\n * Created by zw on 2015/7/7.\r\n */\r\nvar dbStructure=require('./db_structure');\r\nvar articleModel=dbStructure.articleModel;\r\nvar keyModel=dbStructure.keyModel;\r\nvar userModel=dbStructure.userModel;\r\nvar attachmentModel=dbStructure.attachmentModel;\r\nvar commentModel=dbStructure.commentModel;\r\nvar innerImageModel=dbStructure.innerImageModel;\r\nvar keyArticleModel=dbStructure.keyArticleModel;\r\n\r\nvar hash=require('../express_component/hashCrypt');\r\nvar async=require('async')\r\nvar generalFunction=require('../express_component/generalFunction').generateFunction\r\nvar miscellaneous=require('../assist_function/miscellaneous').func//可以和generalFunction合并\r\nvar errorRecorder=require('../express_component/recorderError').recorderError;\r\n\r\nvar general=require('../assist/general').general\r\nvar ueConfig=require('../assist/ueditor_config').ue_config\r\n//var articleError=require('../assist/server_error_define').articleError;\r\n//var mongooseError=require('../assist/3rd_party_error_define').mongooseError;\r\n//var mongooseValidateError=require('./assist/3rd_party_error_define').mongooseValidateError;\r\nvar validateDb=require('../error_define/3rd_party_error_define').validateDb;\r\n//var inputDefine=require('../assist/input_define').inputDefine;\r\nvar input_validate=require('../error_define/input_validate').input_validate;\r\nvar runtimeDbError=require('../error_define/runtime_db_error').runtime_db_error;\r\nvar runtimeNodeError=require('../error_define/runtime_node_error').runtime_node_error;\r\n\r\nvar pagination=require('../express_component/pagination').pagination\r\n\r\nvar fs=require('fs')\r\n\r\n//var article=new articleModel();\r\n//根据hashId获得Id\r\nvar hashId2Id=function(articleHashId,callback){\r\n    articleModel.find({hashId:articleHashId},'_id',function(err,articleId){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','hashId2Id')\r\n            return callback(err,runtimeDbError.article.findByHashId)\r\n        }\r\n//console.log(articleId)\r\n        if(0===articleId.length){\r\n            return callback(null,runtimeDbError.article.findByHashIdNull)\r\n        }\r\n        if(1<articleId.length){\r\n            return callback(null,runtimeDbError.article.findByHashIdMulti)\r\n        }\r\n        return callback(null,{rc:0,msg:articleId[0]._id})\r\n    })\r\n}\r\nvar readComment=function(articleHashId,curPage,callback){\r\n    articleModel.find({hashId:articleHashId},'comment mDate cDate',function(err,article){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','readComment')\r\n            return res.json(err,runtimeDbError.article.findByHashId)\r\n        }\r\n        if(null==article){\r\n            return res.json(err,runtimeDbError.article.findByHashIdNull)\r\n        }\r\n//console.log(article)\r\n        var findedArticle=article[0]\r\n        var paginationInfo=pagination(findedArticle.comment.length,curPage,general.commentPageSize,general.commentPageLength)\r\n//console.log(paginationInfo)\r\n//\r\n//                 {path:'comment',model:'comments',select:'content  mDate user',options:{limit:general.commentPageSize}}\r\n//        console.log(general.commentPageSize)\r\n        var opt=[{path:'comment',model:'comments',select:' content mDate user',options:{limit:general.commentPageSize,skip:(paginationInfo.curPage-1)*general.commentPageSize}}]\r\n        findedArticle.populate(opt,function(err,article1){\r\n            if(err){\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'article','readComment')\r\n                return callback(err,runtimeDbError.comment.readComment)\r\n            }\r\n            //console.log(opt)\r\n            //console.log(article1)\r\n            //读取comment的用户信息\r\n            async.forEachOf(article1.comment,function(value,key,cb){\r\n                //'name thumbnail cDate mDate mDateConv',\r\n                userModel.findById(value.user,' name thumbnail  mDate',function(err,findedUser){\r\n                    if(err ){\r\n                        errorRecorder({rc:err.code,msg:err.errmsg},'article','readComment')\r\n                        cb(err,runtimeDbError.user.findById)\r\n                    }else{\r\n                        if(null===findedUser){\r\n                            article1.comment[key].user=undefined//userId没有查找到对应的记录，则把user改成undefine\r\n                            errorRecorder(runtimeDbError.user.findByIdNull,'article','readArticle')\r\n                            cb(err,runtimeDbError.user.findByIdNull)\r\n                        }else{\r\n                            article1.comment[key].user=undefined//为了替换user(_id)->user(name/phone/cDate...),先要undefined，否则doc1会记住user的原始类型\r\n                            article1.comment[key].user=findedUser\r\n//console.log(findedUser)\r\n                            article1.comment[key].user._id=undefined//删除_id，应为无需传递到客户端\r\n                            cb()\r\n                        }\r\n                    }\r\n                })\r\n            },function(err){\r\n                if(err){\r\n                    return callback(null,runtimeDbError.user.findById)\r\n                }else{\r\n                    //console.log(article1)\r\n                    var finalResult={comment:article1.toObject().comment};\r\n                    //console.log(paginationInfo)\r\n                    finalResult.pagination=paginationInfo;\r\n//console.log(finalResult)\r\n                    return callback(null,{rc:0,msg:finalResult})\r\n                }\r\n            })\r\n\r\n        })\r\n    })\r\n}\r\n\r\n\r\nvar createNewArticle=function(title,authorId,callback){\r\n    var article=new articleModel();\r\n    article.title=title;\r\n    article.author=authorId\r\n\r\n\r\n    var hashID=hash.hash('sha1',article.title);//避免同名冲突(考虑到\"新文件\"\r\n    articleModel.count({hashId:hashID},function(err,result){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','createNewArticle')\r\n            return callback(err,runtimeDbError.article.count)\r\n        }else{\r\n            //如果原始title 的hash id已经存在，那么使用当前时间重新生成一个\r\n            //console.log(result)\r\n            if(0<result){\r\n                var randomString=new Date().getTime()\r\n                randomString+=generalFunction.generateRandomString(4)\r\n//console.log(randomString)\r\n                hashID=hash.hash('sha1',article.title+randomString)\r\n//console.log(hashID)\r\n            }\r\n            article.hashId = hashID;\r\n            //console.log(article._id)\r\n            //article._id = '1111';\r\n            article.cDate=new Date();\r\n            //article.mDate=article.cDate;\r\n//console.log(article)\r\n            validateDb.article(article,'article','createNewArticle',function(validateErr,validateResult){\r\n                if(0===validateResult.rc){\r\n                    article.save(function(err,savedArticle){\r\n                        if(err){\r\n//console.log(err)\r\n                            errorRecorder({rc:err.code,msg:err.errmsg},'article','createNewArticle')\r\n                            return callback(err,runtimeDbError.article.save)\r\n                        }else{\r\n//console.log(savedArticle)\r\n\t\t\t\t\t\t\tvar obj=savedArticle.toObject();\r\n                            return callback(null,{rc:0,msg:obj})\r\n                        }\r\n                    })\r\n                }else{\r\n                    return callback(validateErr,validateResult)//validate err 原样返回\r\n                }\r\n            });\r\n        }\r\n\r\n    })\r\n}\r\n\r\n//更新titl or content\r\n/*\r\n * _id:文档id  type:title or content（更新哪个部分，title和content区分）   obj：要更新的内容\r\n * */\r\nvar updateArticleContent=function(articleHashId,obj,callback){\r\n    //var article=new articleModel();\r\n\r\n\r\n    articleModel.find({hashId:articleHashId},function(err,articleResult){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','findArticle')\r\n            return callback(err,runtimeDbError.article.findByHashId)\r\n        }\r\n        if('[]'===JSON.stringify(articleResult)){\r\n            return callback(null,runtimeDbError.article.findByHashIdNull)\r\n        }\r\n        if(1<articleResult.length){\r\n            return callback(null,runtimeDbError.article.findByHashIdMulti)\r\n        }\r\n        var field=['title','keys','pureContent','htmlContent'];\r\n        var curFieldName;\r\n        var article=articleResult[0]\r\n\r\n        for(var i=0;i<field.length;i++){\r\n            curFieldName=field[i];\r\n            if(undefined!=obj[curFieldName] || null!=obj[curFieldName]){\r\n                article[curFieldName]=undefined\r\n                article[curFieldName]=obj[curFieldName];\r\n            }\r\n        }\r\n        article['mDate']=new Date()\r\n        //console.log(article)\r\n        //2015-09-07    新增state状态\r\n        if(undefined!=obj['state'] && -1===general.state.indexOf(obj['state'])){\r\n            article['state']=general.state[0]\r\n        }else{\r\n            article['state']=obj['state']\r\n        }\r\n//console.log(article)\r\n        //2015-10-10    遍历article.innerImage，在innerImage表中查找对应的记录(hashName). 如果\r\n        //1.    innerImage不存在,对应的innerImage object存入notExistInnerImageKey\r\n        //2.    如果innerImage存在,但是在htmlContent中不存在,object存入notExistInnerImageKey.\r\n        // notExistInnerImageKey是对象数组,存储idx(article.innerImage的index,方便删除),id(objectid, 以便删除innerImage的记录)和标志位deDelOnly. 如果dbDelOnly,只要删除article.innerImage中的数值,否则,还要加上innerImage和disk\r\n        if( undefined!==article.innerImage && 0<article.innerImage.length){\r\n            var notExistInnerImageKey=[]\r\n            async.forEachOf(article.innerImage,function(value,key,cb){\r\n                innerImageModel.findById(value,'hashName',function(err,findedInnerImage){\r\n                    if(err){\r\n                        errorRecorder({rc:err.code,msg:err.errmsg},'article','findInnerImage')\r\n                        return callback(err,runtimeDbError.innerImage.findById)\r\n                    }\r\n                    //article.innerImage中存在,但是innerImage不存在,直接从article.innerImage中删除\r\n                    if(null===findedInnerImage){\r\n                        var articleInnerImageIdx=article.innerImage.indexOf(value)//重新定位index,因为如果之前删除过,那么index会变化\r\n                        if(-1!==articleInnerImageIdx){\r\n                            article.innerImage.splice(articleInnerImageIdx,1)\r\n                        }\r\n                        //notExistInnerImageKey.push({idx:key,dbDelOnly:true})//只要idx,因为只会在article.innerImage操作\r\n                        //article.innerImage.splice(key,1)\r\n                        //console.log('null'+key)\r\n                    }else{\r\n                       /* console.log(findedInnerImage)\r\n                        console.log(article.htmlContent)*/\r\n\r\n                        var idx=article.htmlContent.indexOf(findedInnerImage.hashName)\r\n                        //console.log(idx)\r\n                        if(-1===idx){//innerImage中的hashName已经不存在article.htmlContent了\r\n                            var articleInnerImageIdx=article.innerImage.indexOf(value)//重新定位index,因为如果之前删除过,那么index会变化\r\n                            if(-1!==articleInnerImageIdx){\r\n                                article.innerImage.splice(articleInnerImageIdx,1)\r\n                            }\r\n                            //以下是真正从innerImage中删除\r\n                            innerImageModel.findByIdAndRemove(value,function(err,findedInnerImage1){\r\n                                if(err){\r\n                                    errorRecorder({rc:err.code,msg:err.errmsg},'article','findInnerImage')\r\n                                    return callback(err,runtimeDbError.innerImage.findById)\r\n                                }\r\n                                //console.log(general.ueUploadPath+'/'+ueConfig.imagePathFormat+'/'+findedInnerImage1.hashName)\r\n                                fs.unlinkSync(general.ueUploadPath+'/'+ueConfig.imagePathFormat+'/'+findedInnerImage1.hashName)\r\n                            })\r\n                        }\r\n                    }\r\n                    cb()\r\n                })\r\n\r\n            },function(err){\r\n                if(err){\r\n                    return callback(err)\r\n                }\r\n//console.log()\r\n                //article.innerImage是必需操作的\r\n/*                notExistInnerImageKey.sort(function(a,b){return a.idx< b.idx?1:-1})//对数组的idx进行反向排序（升序的话，执行了一次splice后，后续的idx就无法对齐了）\r\n                notExistInnerImageKey.forEach(function(e){\r\n                    article.innerImage.splice(e.idx,1)\r\n                })*/\r\n\r\n                //根据dbDelOnly确定是否要操作innerImage和disk\r\n                validateDb.article(article,'article','updateArticleContent',function(validateErr,validateResult){\r\n                    if(0===validateResult.rc){\r\n                        article.save(function(err){\r\n                            if(err){\r\n                                errorRecorder({rc:err.code,msg:err.errmsg},'article','updateArticleContent')\r\n                                return callback(err,runtimeDbError.article.save)\r\n                            }else{\r\n                                return callback(null,{rc:0,msg:null})\r\n                            }\r\n                        })\r\n                    }else{\r\n                        return callback(validateErr,validateResult)//validate err 原样返回\r\n                    }\r\n                });\r\n            })\r\n\r\n        }else{\r\n            validateDb.article(article,'article','updateArticleContent',function(validateErr,validateResult){\r\n                if(0===validateResult.rc){\r\n                    article.save(function(err){\r\n                        if(err){\r\n                            errorRecorder({rc:err.code,msg:err.errmsg},'article','updateArticleContent')\r\n                            return callback(err,runtimeDbError.article.save)\r\n                        }else{\r\n                            return callback(null,{rc:0,msg:null})\r\n                        }\r\n                    })\r\n                }else{\r\n                    return callback(validateErr,validateResult)//validate err 原样返回\r\n                }\r\n            });\r\n        }\r\n\r\n\r\n    })\r\n\r\n\r\n\r\n}\r\n\r\n\r\n//根据key（string）获得对应id，如果key不存在，直接保存后获得新id\r\n//返回一个数组（key id）\r\nvar updateArticleKey=function(articleHashId,keys,callback){\r\n    var keyword=new keyModel();\r\n    var keyArray=[]\r\n    //console.log(keys)\r\n    if(0===keys.length){\r\n        return callback(null,{rc:0,msg:null})\r\n    }\r\n    //console.log(keys)\r\n    async.forEachOf(keys,function(value,key,cb){\r\n        keyModel.findOne({key:value},'_id key',function(err,document){\r\n            //console.log(document)\r\n            if(err){cb(err)}\r\n            if(document===null){\r\n                //console.log(value)\r\n                keyword.key=value;\r\n                keyword.cDate=new Date()\r\n                //keyword.mDate=new Date()\r\n                keyword.save(function(err,keyword){\r\n                    //决定保存id还是字符\r\n                    //keyArray.push(keyword._id)\r\n                    keyArray.push(keyword.key)\r\n                })\r\n            }else{\r\n                //决定保存id还是字符\r\n                //keyArray.push(document._id)\r\n                keyArray.push(document.key)\r\n          }\r\n            cb()//如果没有错误，必须执行cb不带任何参数\r\n        })\r\n    },function(err){\r\n        //console.log(keyArray)\r\n        articleModel.find({hashId:articleHashId},'keys',function(err,articleResult){\r\n            if(err){\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'article','updateArticleKey')\r\n                return callback(err,runtimeDbError.article.findById)\r\n            }\r\n            if('[]'===JSON.stringify(articleResult)){\r\n                return callback(null,runtimeDbError.article.findByHashIdNull)\r\n            }\r\n            if(1<articleResult.length){\r\n                return callback(null,runtimeDbError.article.findByHashIdMulti)\r\n            }\r\n            var article=articleResult[0];\r\n            //console.log(article)\r\n            //for(var i=0;i<keyArray.length;i++){\r\n            //    article.keys.push(keyArray[i])\r\n            //}\r\n            //article.keys=undefined;\r\n            article.keys=[];\r\n//console.log(article)\r\n            for(var i=0;i<keyArray.length;i++){\r\n                article.keys.push(keyArray[i])\r\n            }\r\n            //articleResult[0].keys=keyArray\r\n//console.log(keyArray)\r\n//console.log(article)\r\n            article.save(function(err){\r\n                if(err){\r\n                    errorRecorder({rc:err.code,msg:err.errmsg},'article','saveArticleKey')\r\n                    return callback(err,runtimeDbError.article.save)\r\n                }else{\r\n                    return callback(null,{rc:0,msg:null})\r\n                }\r\n            })\r\n\r\n        })\r\n        //callback(err,keyArray)\r\n    })\r\n}\r\n\r\n/*必需在updateKeyArticle之后执行*/\r\n/*\r\n* 1. 查找文档的keyId(objectId)\r\n* 2. 根据文档的_id查找keyArticle表(key-article对应关系)\r\n* 3. 如果2的结果为0,直接插入1中的记录;否则,循环2中的记录,如果不存在1中,删除(用户更改了key或者删除了key)\r\n* 4. 循环1中的记录,和2中对比,如果不存在,添加到keyArticle中\r\n* */\r\n //暂时不需要，可以使用aggregate代替\r\n var updateKeyArticle=function(articleHashId,callback){\r\n    //    因为是在updateArticleKey之后执行,所以不用检测articleHashId\r\n    articleModel.find({hashId:articleHashId},'keys',function(err,findedArticle){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n            return callback(err,runtimeDbError.article.findByHashId)\r\n        }\r\n        if(0===findedArticle.length){\r\n            return callback(null,runtimeDbError.article.findByHashIdNull)\r\n        }\r\n        if(1<findedArticle.length){\r\n            return callback(null,runtimeDbError.article.findByHashIdMulti)\r\n        }\r\n        var article=findedArticle[0]\r\n        keyArticleModel.find({articleId:article._id},function(err,findedKeyArticle){\r\n            if(err){\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n                return callback(err,runtimeDbError.keyArticle.find)\r\n            }\r\n            //还没有任何key-article,直接插入\r\n            if(0===findedKeyArticle.length){\r\n                var keyInArticle=article.keys;\r\n                //文档没有关键字,无需插入\r\n                if(0===keyInArticle.length){\r\n                    return callback(null,{rc:0,msg:null})\r\n                }\r\n                //有关键字,插入maxKeyNum个关键字\r\n                var maxKeyNum= keyInArticle.length>general.maxKeyNum ? general.maxKeyNum:keyInArticle.length;\r\n\r\n                //从article.keys截取出合适数量的key(一般是所有的key)\r\n                var validateKey=keyInArticle.splice(0,maxKeyNum);\r\n                async.forEachOf(validateKey,function(key,value,cb){\r\n                    var keyArticle=new keyArticleModel()\r\n                    keyArticle.articleId=article._id;\r\n                    keyArticle.keyId=value\r\n                    validateDb.keyArticle(keyArticle,'article','updateKeyArticle',function(err,result){\r\n                        if(0!==result.rc){\r\n                            return callback(null,result)\r\n                        }\r\n                        keyArticle.save(function(err){\r\n                            if(err){\r\n                                errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n                                return callback(err,runtimeDbError.keyArticle.save)\r\n                            }\r\n                            cb()//当前运行结束\r\n                        })\r\n                    })\r\n                },function(err){\r\n                    return callback(null,{rc:0,msg:null})\r\n                })\r\n/*                for(var i=0;i<maxKeyNum;i++){\r\n                    var keyArticle=new keyArticleModel()\r\n                    keyArticle.articleId=article._id;\r\n                    keyArticle.keyId=keyInArticle[i]\r\n                    validateDb.keyArticle(keyArticle,'article','updateKeyArticle',function(err,result){\r\n                        if(0!==result.rc){\r\n                            return callback(null,result)\r\n                        }\r\n                        keyArticle.save(function(err){\r\n                            if(err){\r\n                                errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n                                return callback(err,runtimeDbError.keyArticle.save)\r\n                            }\r\n                        })\r\n                    })\r\n                }*/\r\n\r\n\r\n            }\r\n\r\n            //有对应的keyarticle,需要进行检测\r\n            if(0<findedKeyArticle.length){\r\n                var keyInArticle=article.keys;\r\n                //key-article存在,\r\n                var maxKeyNum= keyInArticle.length>general.maxKeyNum ? general.maxKeyNum:keyInArticle.length;\r\n\r\n                async.forEachOf(findedKeyArticle,function(value,key,cb){\r\n                    //检测key-article是否可以删除\r\n                    if(-1===keyInArticle.indexOf(value.keyId)){\r\n                        keyArticleModel.remove({_id:value._id},function(err){\r\n                            if(err){\r\n                                errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n                                return callback(err,runtimeDbError.keyArticle.remove)\r\n                            }\r\n                            cb()//当前运行结束\r\n                        })\r\n                    }\r\n                },function(err){\r\n\r\n                })\r\n\r\n                async.forEachOf(keyInArticle,function(key,value,cb){\r\n                    if(-1===miscellaneous.objectIndexOf('keyId',value,findedKeyArticle)){\r\n                        var keyArticle1=new keyArticleModel()\r\n                        keyArticle1.articleId=article._id;\r\n                        keyArticle1.keyId=value\r\n                        validateDb.keyArticle(keyArticle1,'article','updateKeyArticle',function(err,result){\r\n                            if(0!==result.rc){\r\n                                return callback(null,result)\r\n                            }\r\n                            keyArticle1.save(function(err){\r\n                                if(err){\r\n                                    errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n                                    return callback(err,runtimeDbError.keyArticle.save)\r\n                                }\r\n                            })\r\n                        })\r\n                    }\r\n                },function(err){\r\n\r\n                })\r\n                /*//检测key-article是否可以删除\r\n                for(var i=0;i<findedKeyArticle.length;i++){\r\n                    if(-1===keyInArticle.indexOf(findedKeyArticle[i].keyId)){\r\n                        keyArticleModel.remove({_id:findedKeyArticle[i]._id},function(err){\r\n                            if(err){\r\n                                errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n                                return callback(err,runtimeDbError.keyArticle.remove)\r\n                            }\r\n\r\n                        })\r\n                    }\r\n                }\r\n\r\n                //  检测是否需要添加key-article\r\n                for(var i=0;i<keyInArticle.length;i++){\r\n                    //在article中的key还没有保存到key-article中\r\n                    if(-1===miscellaneous.objectIndexOf('keyId',keyInArticle[i],findedKeyArticle)){\r\n                        var keyArticle1=new keyArticleModel()\r\n                        keyArticle1.articleId=article._id;\r\n                        keyArticle1.keyId=keyInArticle[i]\r\n                        validateDb.keyArticle(keyArticle1,'article','updateKeyArticle',function(err,result){\r\n                            if(0!==result.rc){\r\n                                return callback(null,result)\r\n                            }\r\n                            keyArticle1.save(function(err){\r\n                                if(err){\r\n                                    errorRecorder({rc:err.code,msg:err.errmsg},'article','updateKeyArticle')\r\n                                    return callback(err,runtimeDbError.keyArticle.save)\r\n                                }\r\n                            })\r\n                        })\r\n                    }\r\n                }*/\r\n\r\n                return callback(null,{rc:0,msg:null})\r\n            }\r\n        })\r\n    })\r\n}\r\n/*\r\n *   innerImgOjb:{_id, name, storePath, size}\r\n * */\r\nvar addInnerImage=function(articleHashID,innerImageModel,callback){\r\n\r\n    articleModel.find({hashId:articleHashID},'innerImage',function(err,document){\r\n        if(err){\r\n            if(express().get('env')==='development'){\r\n                throw err;\r\n            }\r\n            if(express().get('env')==='production'){\r\n                //clientResult=articleError.notExist.error//this show to client\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'article','addArticleAttachment')\r\n                /*                dbResult=mongooseError.findByIDArticle//this is save into db\r\n                 errorRecorder(dbResult.rc,dbResult.msg,'查找文档'+articleID+'出错','article')*/\r\n                return callback(err,runtimeDbError.article.findByHashId)\r\n            }\r\n\r\n        }\r\n//console.log(document)\r\n        if(null===document){\r\n\r\n            return callback(null,runtimeDbError.article.findByHashIdNull)\r\n        }else{\r\n            if(document.length>1){\r\n\r\n                return callback(null,runtimeDbError.article.findByHashIdMulti)\r\n            }\r\n\r\n/*            var innerImage=new innerImageModel();\r\n            innerImage.hashName=innerImageObj.hashName;\r\n            innerImage.name=innerImageObj.name\r\n            innerImage.storePath=innerImageObj.storePath\r\n            innerImage.size=innerImageObj.size\r\n            innerImage.cDate=new Date()*/\r\n\r\n            validateDb.innerImage(innerImageModel,'article','addInnerImage',function(validateErr,validateResult){\r\n                //console.log(validateResult)\r\n                if(0===validateResult.rc){\r\n                    innerImageModel.save(function(err,savedInnerImage){\r\n                        //console.log(savedInnerImage)\r\n                        if(err){\r\n                            errorRecorder({rc:err.code,msg:err.errmsg},'article','innerImage');\r\n                            return callback(err,runtimeDbError.innerImage.save)\r\n                        }else{\r\n                            document[0].innerImage.push(savedInnerImage._id)\r\n                            document[0].save(function(err,savedDoc){\r\n                                if(err){\r\n                                    errorRecorder({rc:err.code,msg:err.errmsg},'article','article');\r\n                                    return callback(err,runtimeDbError.article.save)\r\n                                }else{\r\n//console.log(savedDoc)\r\n                                    return callback(null,{rc:0,msg:savedInnerImage})\r\n                                }\r\n                            })\r\n                        }\r\n                    })\r\n                }else{\r\n                    return callback(validateErr,validateResult)\r\n                }\r\n            })\r\n\r\n\r\n        }\r\n    })\r\n    //console.log(keys)\r\n}\r\n//根据attachmentId获得对应的hashName，以便下载附件\r\nvar getAttachmentHashName=function(attachmentId,callback){\r\n    attachmentModel.findById(attachmentId,'hashName name',function(err,result){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','getAttachmentHashName')\r\n            return callback(err,runtimeDbError.attachment.findById)\r\n        }\r\n//console.log(result)\r\n        if(undefined===result){\r\n            return callback(null,runtimeNodeError.attachment.attachmentNotFind)\r\n        }\r\n\r\n        return callback(null,{rc:0,msg:result})\r\n    })\r\n}\r\n/*\r\n *   attachmentOjb:{_id, name, storePath, size}\r\n * */\r\nvar addAttachment=function(articleHashID,attachmentModel,callback){\r\n    //var attachments=new attachmentModel();\r\n\r\n\r\n    articleModel.find({hashId:articleHashID},'attachment',function(err,document){\r\n        if(err){\r\n            if(express().get('env')==='development'){\r\n                throw err;\r\n            }\r\n            if(express().get('env')==='production'){\r\n                //clientResult=articleError.notExist.error//this show to client\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'article','addArticleAttachment')\r\n                /*                dbResult=mongooseError.findByIDArticle//this is save into db\r\n                 errorRecorder(dbResult.rc,dbResult.msg,'查找文档'+articleID+'出错','article')*/\r\n                return callback(err,runtimeDbError.article.findByHashId)\r\n            }\r\n\r\n        }\r\n//console.log(document)\r\n        if(null===document){\r\n            return callback(null,runtimeDbError.article.findByHashIdNull)\r\n        }\r\n        if(document.length>1){\r\n            return callback(null,runtimeDbError.article.findByHashIdMulti)\r\n        }\r\n\r\n        validateDb.attachment(attachmentModel,'article','addAttachment',function(validateErr,validateResult){\r\n            if(0===validateResult.rc){\r\n                attachmentModel.save(function(err,savedAttachment){\r\n                    //console.log(err)\r\n                    if(err){\r\n                        errorRecorder({rc:err.code,msg:err.errmsg},'article','attachment');\r\n                        return callback(err,runtimeDbError.attachment.save)\r\n                    }\r\n\r\n                    document[0].attachment.push(savedAttachment._id)\r\n                    document[0].save(function(err){\r\n                        if(err){\r\n                            errorRecorder({rc:err.code,msg:err.errmsg},'article','article');\r\n                            return callback(err,runtimeDbError.article.save)\r\n                        }\r\n                        //添加附件成功，返回对应的参数（_id,hashName，size，cDate），以便显示在页面上\r\n                        return callback(null,{rc:0,msg:savedAttachment.toObject()})\r\n\r\n                    })\r\n                })\r\n            }else{\r\n                return callback(validateErr,validateResult)\r\n            }\r\n        })\r\n\r\n\r\n\r\n    })\r\n    //console.log(keys)\r\n}\r\n\r\nvar delAttachment=function(articleHashID,attachmentID,callback){\r\n    /*    attachmentModel.count({_id:attachmentID},function(err,result){\r\n     if(err){\r\n     errorRecorder(err.code,err.errmsg,'article','attachment');\r\n     clientResult=mongooseError.countAttachment;\r\n     return callback(err,clientResult)\r\n     }\r\n\r\n     if(result)\r\n     })*/\r\n    //mongodb会保证_id的唯一性，所以无需count来再次检测\r\n    attachmentModel.findByIdAndRemove(attachmentID,{select:\"_id hashName\"},function(err,attachment){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','delAttachment');\r\n\r\n            return callback(err,runtimeDbError.attachment.findByIdAndRemove)\r\n        }\r\n//console.log(attachment)\r\n        articleModel.find({hashId:articleHashID},'attachment',function(err,article){\r\n            if(err)\r\n            {\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'article','findArticle')\r\n                return callback(err,runtimeDbError.article.findByHashId)\r\n            }\r\n\r\n            //if(null===attachment)\r\n            var idx=article[0].attachment.indexOf(attachment._id);\r\n/*console.log(idx)\r\n            console.log(article)*/\r\n            if(-1!=idx){\r\n                article[0].attachment.splice(idx,1);\r\n                article[0].save(function(err){\r\n                    if(err){\r\n                        errorRecorder({rc:err.code,msg:err.errmsg},'article','delArticleAttachment')\r\n                        return callback(err,runtimeDbError.article.save)\r\n                    }else{\r\n                        //返回文件的hashName，以便在disk中删除文件\r\n                        return callback(null,{rc:0,msg:attachment})\r\n                    }\r\n                })\r\n            }\r\n\r\n        })\r\n    })\r\n}\r\n\r\n\r\nvar addComment=function(articleHashID,userId,content,callback){\r\n    articleModel.find({hashId:articleHashID},'comment mDate',function(err,article){\r\n        if(err)\r\n        {\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','findArticle')\r\n            return callback(err,runtimeDbError.article.findByHashId)\r\n        }\r\n        var comment=new commentModel()\r\n\r\n        comment.user=userId;\r\n        comment.content=content;\r\n        //comment.mDate=Date()\r\n        hashId2Id(articleHashID,function(err,findedArticleId){\r\n//console.log(result)\r\n            if(0<findedArticleId.rc){\r\n                return callback(null,findedArticleId)\r\n            }\r\n            comment.articleId=findedArticleId.msg;\r\n            validateDb.comment(comment,'article','addComment',function(validateErr,validateResult){\r\n                if(0!=validateResult.rc){\r\n                    return callback(validateErr,validateResult)\r\n                }\r\n                comment.save(function(err,comment,affectedNum){\r\n                    if(err)\r\n                    {\r\n                        errorRecorder({rc:err.code,msg:err.errmsg},'article','saveComment')\r\n                        return callback(err,runtimeDbError.comment.save)\r\n                    }\r\n                    var comment=comment.toObject()\r\n                    //console.log(comment)\r\n                    var findedArticle=article[0];\r\n                    if(null===findedArticle.comment || undefined===findedArticle.comment){\r\n                        findedArticle.comment=[]\r\n                    }\r\n//console.log(article.comment)\r\n                    findedArticle.comment.push(comment._id);\r\n//console.log(findedArticle)\r\n                    findedArticle.save(function(err,savedArticle){\r\n                        //console.log(err)\r\n                        //console.log(savedArticle)\r\n                        if(err){\r\n                            errorRecorder({rc:err.code,msg:err.errmsg},'article','updateArticleComment')\r\n                            return callback(err,runtimeDbError.article.save)\r\n                        }else{\r\n                            userFindById(userId,function(err,result){\r\n\r\n                                //comment 需要返回\r\n                                //var comment=comment.toObject();\r\n                                var user=result.msg.toObject();\r\n\r\n                                if(0!=result.rc){\r\n                                    return callback(err,result)\r\n                                }else{\r\n                                    comment.user=user\r\n                                    comment.articleId=undefined\r\n\r\n                                    //最终返回的结果，应该是populate user的\r\n                                    //console.log(comment)\r\n                                    return callback(null,{rc:0,msg:comment})\r\n                                }\r\n                            })\r\n\r\n                        }\r\n                    })\r\n\r\n                })\r\n\r\n            })\r\n        })\r\n\r\n\r\n\r\n    })\r\n}\r\n\r\nvar delComment=function(articleHashID,commentID,callback){\r\n    articleModel.findById(articleHashID,'comment',function(err,article) {\r\n        if (err) {\r\n            errorRecorder({rc:err.code, msg:err.errmsg}, 'article', 'findArticle')\r\n            return callback(err, runtimeDbError.article.findByHashId)\r\n        }\r\n        commentModel.findByIdAndRemove(commentID,function(err,comment){\r\n            if (err) {\r\n                errorRecorder({rc:err.code, msg:err.errmsg}, 'article', 'removeComment')\r\n                return callback(err, runtimeDbError.comment.findByIdAndRemove)\r\n            }\r\n            /*            if(null===comment){\r\n             return callback(null,true)\r\n             }*/\r\n            var idx=article.comment.indexOf(commentID)\r\n            //console.log(comment._id)\r\n            //console.log(idx)\r\n            //return callback(null,true)\r\n            if(-1!=idx){\r\n                //var comments=article.comment\r\n                //comments.splice(idx,1)\r\n                //console.log(comments.splice(idx,1))\r\n                //console.log(article.comment)\r\n                article.comment.splice(idx,1)\r\n//console.log(article.comment)\r\n                article.save(function(err){\r\n                    if (err) {\r\n                        errorRecorder({rc:err.code, msg:err.errmsg}, 'article', 'findArticle')\r\n                        return callback(err, runtimeDbError.article.save)\r\n                    }else{\r\n                        callback(null,{rc:0,msg:null})\r\n                    }\r\n                })\r\n\r\n            }\r\n\r\n        })\r\n    })\r\n\r\n}\r\n\r\nvar userFindById=function(userId,callback){\r\n    userModel.findById(userId,'name thumbnail mDate cDate',function(err,findedUser){\r\n        if(err ){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'article','readArticle')\r\n            return callback(err,runtimeDbError.user.findById)\r\n\r\n            //return callback(err,{result:false,content:mongooseError.findByIdUser})\r\n        }\r\n        if(null===findedUser){\r\n            errorRecorder(runtimeDbError.user.findByIdNull,'article','readArticle')\r\n            return callback(err,runtimeDbError.user.findByIdNull)\r\n        }\r\n        return callback(null,{rc:0,msg:findedUser})\r\n    })\r\n}\r\n\r\nvar readArticle=function(articleHashID,callback){\r\n    //console.log('start')\r\n    //console.log(articleHashID)\r\n    articleModel.find({hashId:articleHashID},function(err,doc){\r\n        //console.log(articleHashID)\r\n        //console.log(Date().toLocaleString())\r\n        //doc[0].mDate=doc[0].mDate.toLocaleDateString()//+doc[0].mDate.toLocaleTimeString()\r\n        //doc[0].mDate=undefined\r\n        //console.log(doc[0].mDate)\r\n        //console.log(doc[0].mDate.toLocaleTimeString())\r\n        //doc[0].mDate=\"1980-08-07\"\r\n        //console.log(doc[0].mDate)\r\n        //doc[0].mDate=undefined\r\n        //console.log(doc[0].mDate)\r\n        //var tmp=doc[0].toObject()\r\n        //tmp.mDate='1990-08-07'\r\n        //console.log(tmp.mDate)\r\n//miscellaneous.convDBToObj(doc)\r\n        if (err) {\r\n            errorRecorder({rc:err.code, msg:err.errmsg}, 'article', 'findArticle')\r\n            return callback(err, runtimeDbError.article.findByHashId)\r\n        }\r\n        if(null===doc){\r\n            return callback(null,runtimeDbError.article.findByHashIdNull)//没有err，但是结果为false，那么需要重定向\r\n        }\r\n/*        if(undefined!==doc.author && userId!==doc.author){\r\n            return callback()\r\n        }*/\r\n        //赶在populate之前获得comment总数（因为populate中限制了comment总数）\r\n        var totalCommentNum=0\r\n        //console.log(doc)\r\n        if(undefined!==doc[0].comment){\r\n            totalCommentNum=doc[0].comment.length\r\n        };\r\n//console.log(doc)\r\n//        console.log(totalCommentNum,general.commentPageSize,general.commentPageLength)\r\n        var paginationResult=pagination(totalCommentNum,1,general.commentPageSize,general.commentPageLength)\r\n//console.log(paginationResult)\r\n        //(article.comment.length,curPage,pageSize,pageLength)\r\n        var opt=[\r\n            {path:'author',model:'users',select:'name mDate'},\r\n            //{path:'keys',model:'keys',select:'key'},\r\n            {path:'comment',model:'comments',select:'content  mDate user',options:{limit:general.commentPageSize}},//读取最初的几条记录\r\n            {path:'innerImage',model:'innerImages',select:'name storePath cDate mDate'},\r\n            {path:'attachment',model:'attachments',select:'name size cDate',options:{sort:'cDate'}}\r\n        ]\r\n        //console.log(doc)\r\n        doc[0].populate(opt,function(err,doc1){\r\n\r\n            if(err){\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'article','readArticle')\r\n                return callback(err,runtimeDbError.article.findById)\r\n            }else{\r\n/*                optComment=[\r\n                    {path:'user',model:'users',select:'name mobile cDate mDate'}\r\n                ]*/\r\n                //mongoos只支持单层populate，多层populate只能手工完成\r\n                async.forEachOf(doc1.comment,function(value,key,cb){\r\n/*                    { _id: 55c40daa8135d6d82f0f2c92,\r\n                        content: 'content1',\r\n                        user: 55c4096740f0a0d025917528 }*/\r\n                    //console.log(value)\r\n                    //0,1,2.......\r\n                    //console.log(value)\r\n                    userModel.findById(value.user,'name thumbnail cDate mDate',function(err,findedUser){\r\n                        if(err ){\r\n                            errorRecorder({rc:err.code,msg:err.errmsg},'article','readArticle')\r\n                            cb(err,runtimeDbError.user.findById)\r\n                            //return callback(err,{result:false,content:mongooseError.findByIdUser})\r\n                        }else{\r\n                            if(null===findedUser){\r\n                                doc1.comment[key].user=undefined//userId没有查找到对应的记录，则把user改成undefine\r\n                                errorRecorder(runtimeDbError.user.findByIdNull,'article','readArticle')\r\n                                cb(err,runtimeDbError.user.findByIdNull)\r\n                            }else{\r\n                                doc1.comment[key].user=undefined//为了替换user(_id)->user(name/phone/cDate...),先要undefined，否则doc1会记住user的原始类型\r\n                                doc1.comment[key].user=findedUser\r\n                                doc1.comment[key].user._id=undefined//删除_id，应为无需传递到客户端\r\n                                cb()\r\n                            }\r\n                        }\r\n\r\n\r\n                    })\r\n\r\n\r\n                },function(err){\r\n                        if(err){\r\n                           return callback(null,err)\r\n                        }else{\r\n                            //console.log(doc1)\r\n                            finalResult=doc1.toObject()\r\n\r\n                            finalResult.pagination=paginationResult\r\n                            return callback(null,{rc:0,msg:finalResult})\r\n                        }\r\n                })\r\n//                doc1.populate(opt,function(err,docWithCommentUser){\r\n////console.log(docWithCommentUser)\r\n//                    return callback(null,{result:true,content:docWithCommentUser})\r\n//                })\r\n\r\n            }\r\n        })\r\n    })\r\n}\r\n\r\nexports.articleDboperation={\r\n    createNewArticle:createNewArticle,\r\n    updateArticleContent:updateArticleContent,\r\n    updateArticleKey:updateArticleKey,\r\n    //updateKeyArticle:updateKeyArticle,//可以使用aggregate代替\r\n    getAttachmentHashName:getAttachmentHashName,\r\n    addAttachment:addAttachment,\r\n    delAttachment:delAttachment,\r\n    addComment:addComment,\r\n    delComment:delComment,\r\n    readArticle:readArticle,\r\n    addInnerImage:addInnerImage,\r\n    readComment:readComment\r\n\r\n\r\n}"]}