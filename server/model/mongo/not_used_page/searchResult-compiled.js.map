{"version":3,"sources":["searchResult.js"],"names":[],"mappings":"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","file":"searchResult-compiled.js","sourcesContent":["/**\r\n * Created by zw on 2015/9/20.\r\n */\r\n/*                              db                                */\r\nvar dbStructure=require('./db_structure');\r\nvar userModel=dbStructure.userModel;\r\nvar articleModel=dbStructure.articleModel\r\nvar keyModel=dbStructure.keyModel;\r\n/*                         validate and error                           */\r\n//var validateDb=require('../assist/3rd_party_error_define').validateDb;\r\nvar input_validate=require('../error_define/input_validate').input_validate;\r\nvar errorRecorder=require('../express_component/recorderError').recorderError;\r\nvar runtimeDbError=require('../error_define/runtime_db_error').runtime_db_error;\r\nvar runtimeNodeError=require('../error_define/runtime_node_error').runtime_node_error;\r\n\r\n/*                          MISC                                    */\r\n//var hashCrypt=require('../express_component/hashCrypt');\r\n//var async=require('async')\r\nvar general=require('../assist/general').general\r\nvar miscellaneous=require('../assist_function/miscellaneous').func\r\n//var pemFilePath='./other/key/key.pem'; //相对于网站根目录（此处是h:/ss_express/ss_express/)\r\nvar async=require('async')\r\nvar pagination=require('../express_component/pagination').pagination\r\n//获得关键字的id\r\nvar convertKeyword=function(keywordArray,callback){\r\n/*    async,forEachOf(keywordArray,function(key,value,cb){\r\n\r\n    },function(err){\r\n\r\n    })*/\r\n\r\n}\r\n\r\n//var calcSkipLimit=function(total,curPage){\r\n//\r\n//}\r\n//使用aggregate获得数据\r\n//1. 读取key的id,存入数组\r\n//2. 根据1中,对article的keys进行查找,根据符合的数量进行排序,返回 _id和count\r\n//3. 根据2中的数据,查找article(不在2中直接返回article的所有内容,是因为怕太多字段,占用内存)\r\nvar getSearchResult=function(keywordArray,curPage,callback){\r\n    //keyModel.aggregate({$match:{key:'CAPA'}})\r\n    var newCurPage=curPage//不知为何，function的参数surPage无法传递到articleModel.aggregate内部\r\n    keyModel.aggregate([{$match:{key:{$in:{$toLower:keywordArray}}}},{$project:{_id:1,key:1}},{$group:{_id:null,keys:{$push:\"$key\"}}}],function(err,res){\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'searchResult','getSearchResult')\r\n            return callback(err,runtimeDbError.key.aggregateByKeyName)\r\n        }\r\n        if(0===res[0].length){\r\n            return callback(null,runtimeNodeError.searchResult.notMatchArticle)\r\n        }\r\n        var matchKeyId=res[0].keys\r\n        articleModel.aggregate([\r\n            {$unwind:\"$keys\"},//次序会影响结果,要先unwind,然后match\r\n            //{$match:{$or:[{keys:{$in:matchKeyId},state:'编辑完成'}]}},\r\n            {$match:{keys:{$in:matchKeyId}}},\r\n            {$group:{_id:\"$_id\",count:{$sum:1}}},\r\n            {$sort:{count:-1}}\r\n        ],function(err,result){\r\n/*            [ { _id: 55f1102514ca7c301476d2a7, count: 1 },\r\n                { _id: 55f1102414ca7c301476d2a5, count: 1 } ]*/\r\n            if(err){\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'searchResult','getSearchResult')\r\n                return callback(err,runtimeDbError.article.aggregateByKeyName)\r\n            }\r\n            if(0===result.length){\r\n                //return callback(null,runtimeNodeError.searchResult.notMatchArticle)\r\n                return callback(null,{rc:0,msg:undefined})\r\n            }\r\n            //利用分页函数重定位cuPage\r\n            var total=result.length\r\n            var paginationResult=pagination(total,newCurPage,general.searchResultPageSize,general.searchResultPageLength)\r\n            var curPage=paginationResult.curPage\r\n            var findOpt={skip:general.searchResultPageSize*(curPage-1),limit:general.searchResultPageSize}\r\n\r\n            var matchArticleId=miscellaneous.extractKey('_id',result)\r\n            var populateOpt=[\r\n                {path:'author',model:'users',select:'-_id name'}//对于tree,只要title\r\n                //{path:'comment',model:'comments',select:'content mDate user',options:{limit:general.commentPageSize}}\r\n            ]\r\n            articleModel.find({_id:{$in:matchArticleId}},'-_id hashId author title htmlContent pureContent keys mDate',findOpt,function(err,findedSearchResult){\r\n                if(err){\r\n                    errorRecorder({rc:err.code,msg:err.errmsg},'searchResult','getSearchResult')\r\n                    return callback(err,runtimeDbError.article.find)\r\n                }\r\n//console.log(findedSearchResult)\r\n                articleModel.populate(findedSearchResult,populateOpt,function(err,populatedResult){\r\n                //findedSearchResult.populate(opt,function(err,populatedResult){\r\n                //    return callback(null,{rc:0,msg:populatedResult})\r\n                    return callback(null,{rc:0,msg:{results:populatedResult,pagination:paginationResult}})\r\n                })\r\n\r\n\r\n\r\n            })\r\n        })\r\n/*        articleModel.aggregate([\r\n            {$match:{keys:{$in:}}}\r\n        ],function(err,result){\r\n\r\n        })*/\r\n        //return callback(null,{rc:0,msg:res[0].keys})\r\n    })\r\n//var test1=test.match({key:'asdf'})\r\n\r\n    //var test=articleModel.aggregate({$match:{keys:{$in:keywordArray}}})//.unwind('keys').group({_id:\"$_id\",count:{$sum:1}}).sort({count:-1})\r\n    //return callback(null,test)\r\n}\r\n\r\n//直接使用mongodb提供的$text:{$search:keyString对所有的textIndex（title/key/pureContent）查找\r\nvar getSearchResult1=function(keyString,curPage,callback){\r\n//keyString='常用';\r\n    var newCurPage=curPage//不知为何，function的参数surPage无法传递到articleModel.aggregate内部\r\n    var searchOpt=[\r\n        {$match:{$text:{$search:keyString}}}\r\n        ,{$sort:{rank:{$meta:\"textScore\"}}}\r\n        ,{$project:{\"_id\":1}}//为了populate使人民居住作者名字，所以只能先获得article id\r\n    ]\r\n//console.log(keyString)\r\n    articleModel.aggregate(searchOpt,function(err,result){\r\n//console.log(err)\r\n        if(err){\r\n            errorRecorder({rc:err.code,msg:err.errmsg},'searchResult','getSearchResult')\r\n            return callback(err,runtimeDbError.article.find)\r\n        }\r\n\r\n        if(0===result.length){\r\n            //return callback(null,runtimeNodeError.searchResult.notMatchArticle)\r\n            return callback(null,{rc:0,msg:undefined})\r\n        }\r\n        //利用分页函数重定位cuPage\r\n        var total=result.length\r\n        var paginationResult=pagination(total,newCurPage,general.searchResultPageSize,general.searchResultPageLength)\r\n        var curPage=paginationResult.curPage\r\n        var findOpt={skip:general.searchResultPageSize*(curPage-1),limit:general.searchResultPageSize}\r\n\r\n        var matchArticleId=miscellaneous.extractKey('_id',result)\r\n        var populateOpt=[\r\n            {path:'author',model:'users',select:'-_id name'}//对于tree,只要title\r\n            //{path:'comment',model:'comments',select:'content mDate user',options:{limit:general.commentPageSize}}\r\n        ]\r\n        articleModel.find({_id:{$in:matchArticleId}},'-_id hashId author title htmlContent pureContent keys mDate',findOpt,function(err,findedSearchResult){\r\n            if(err){\r\n                errorRecorder({rc:err.code,msg:err.errmsg},'searchResult','getSearchResult')\r\n                return callback(err,runtimeDbError.article.find)\r\n            }\r\n            articleModel.populate(findedSearchResult,populateOpt,function(err,populatedResult){\r\n                //findedSearchResult.populate(opt,function(err,populatedResult){\r\n                //console.log(populatedResult)\r\n                return callback(null,{rc:0,msg:{results:populatedResult,pagination:paginationResult}})\r\n            })\r\n\r\n\r\n        })\r\n    })\r\n}\r\nexports.searchResultDbOperation={\r\n    getSearchResult:getSearchResult,\r\n    getSearchResult1:getSearchResult1\r\n}"]}