{"version":3,"sources":["personalInfo.js"],"names":[],"mappings":"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","file":"personalInfo-compiled.js","sourcesContent":["/**\r\n * Created by wzhan039 on 2015-09-08.\r\n */\r\n/*                              db                                */\r\nvar dbStructure=require('./db_structure');\r\nvar userModel=dbStructure.userModel;\r\n\r\n/*                         validate and error                           */\r\nvar validateDb=require('../error_define/3rd_party_error_define').validateDb;\r\nvar input_validate=require('../error_define/input_validate').input_validate;\r\nvar errorRecorder=require('../express_component/recorderError').recorderError;\r\nvar runtimeDbError=require('../error_define/runtime_db_error').runtime_db_error;\r\nvar runtimeNodeError=require('../error_define/runtime_node_error').runtime_node_error;\r\n\r\n/*                          MISC                                    */\r\nvar hashCrypt=require('../express_component/hashCrypt');\r\nvar async=require('async')\r\nvar general=require('../assist/general').general\r\nvar generalFunc=require('../express_component/generalFunction').generateFunction\r\nvar pemFilePath=generalFunc.getPemFile(general.pemPath); //相对于网站根目录（此处是h:/ss_express/ss_express/)\r\n/********************************************************************/\r\n/*                          function                                */\r\n/********************************************************************/\r\n\r\nvar getBasicInfo=function(userId,callback){\r\n    userModel.findById(userId,function(err,findedUser){\r\n        if(err){\r\n            errorRecorder({rc: err.code, msg: err.errmsg}, 'getBasicInfo', 'findById');\r\n            return callback(err, runtimeDbError.user.findById)\r\n        }\r\n        return callback(null,{rc:0,msg:findedUser})\r\n    })\r\n}\r\nvar saveBasicInfo=function(userId,userName,mobilePhone,callback){\r\n    userModel.findById(userId,function(err,findedUser){\r\n        if(err){\r\n            errorRecorder({rc: err.code, msg: err.errmsg}, 'getBasicInfo', 'findById');\r\n            return callback(err, runtimeDbError.user.findById)\r\n        }\r\n        findedUser.name=userName;\r\n        findedUser.mobilePhone=mobilePhone;\r\nconsole.log(findedUser)\r\n        validateDb.user(findedUser,'saveBasicInfo','validate',function(err,validateResult){\r\n            if(0<validateResult.rc){\r\n                return callback(null,validateResult)\r\n            }\r\n            findedUser.save(function(err){\r\n                if(err){\r\n                    errorRecorder({rc: err.code, msg: err.errmsg}, 'getBasicInfo', 'save');\r\n                    return callback(err, runtimeDbError.user.save)\r\n                }\r\n                return callback(null,{rc:0,msg:null})\r\n            })\r\n        })\r\n    })\r\n}\r\nvar savePasswordInfo=function(userId,oldPassword,newPassword,callback){\r\n    var encryptedPassword=hashCrypt.hmac('sha1',oldPassword,pemFilePath);\r\n//console.log(encryptedPassword)\r\n    userModel.find({_id:userId,password:encryptedPassword},function(err,findedUser){\r\n        if(err){\r\n            errorRecorder({rc: err.code, msg: err.errmsg}, 'savePasswordInfo', 'find');\r\n            return callback(err, runtimeDbError.user.findUser)\r\n        }\r\n        if(0===findedUser.length){\r\n            return callback(null,runtimeDbError.user.findUserByPwd)\r\n        }\r\n        if(1<findedUser.length){\r\n            return callback(null,runtimeDbError.user.findUserMulti)\r\n        }\r\n\r\n        var user=findedUser[0]\r\n        var newEncryptPassword=hashCrypt.hmac('sha1',newPassword,pemFilePath);\r\n        user.password=newEncryptPassword;\r\n        user.save(function(err){\r\n            if(err){\r\n                errorRecorder({rc: err.code, msg: err.errmsg}, 'savePasswordInfo', 'save');\r\n                return callback(err, runtimeDbError.user.save)\r\n            }\r\n            return callback(null,{rc:0,msg:null})\r\n        })\r\n    })\r\n}\r\n\r\nexports.personalInfoDbOperation={\r\n    getBasicInfo:getBasicInfo,\r\n    saveBasicInfo:saveBasicInfo,\r\n    savePasswordInfo:savePasswordInfo\r\n}"]}