{"version":3,"sources":["structure.js"],"names":[],"mappings":"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","file":"structure-compiled.js","sourcesContent":["/**\r\n * Created by wzhan039 on 2015-07-08.\r\n */\r\n\r\nvar mongoose=require('mongoose');\r\nvar fs=require('fs')\r\nvar regex=require('../../../define/regex/regex').regex\r\nvar dbFinance=require('./connection').dbFinance;\r\n\r\n//使用ES6的promise\r\n//mongoose.Promise=Promise\r\n//mongoose.Promise = Promise\r\nvar mongoSetting=require('../../../config/global/globalSettingRule').mongoSetting\r\n\r\nvar inputRule=require('../../../define/validateRule/inputRUle').inputRule\r\n\r\n\r\nvar collections=['department','employee','billType','bill']\r\n\r\n\r\nvar schemaOptions={\r\n    autoIndex:true, //if true,每次app启动，moogoose都会发送ensureIndex给每个index，可能影响性能。\r\n    bufferCommands:true,\t//如果mongodb没有启动，moogoose会缓存命令。//必须\r\n\t//capped:\t//本collection为capped（环形集合，超出最大数量后，新的覆盖老的。插入速度极快）\r\n\t//collection: //collection默认名字是在Model中设置的，为了自定义collection的名称，可以设置此选项\r\n\t//emitIndexErrors：\t//设为true，则当mongoose发出ensureIndex，但是失败后，会在model产生一个error事件\r\n\t//id:\t//vitual getter，用model初始化后的document，可以通过这个方法直接获得objectId（这是mogoose产生的，还没有存入mongodb）\r\n    _id:true,//schema中不用显示设置objectid，mongoose会自动产生objectId\r\n    minimize:true,\t//如果schema中的field是对象，则minimize=true时，当document中此field为空**对象**，此doc被save时，空对象的字段不会被保存\r\n\t//read:,\t//设置read的优选项：primary(default 只从primary读)/primaryPrefered（主要从P，如果P挂掉，从S读）/secondary/secondaryPrefered/nearest（从网络延迟最下的读,需要在connect时候设置var options = { replset: { strategy: 'ping' }};）\r\n    safe:true,\t//设为true，如果出错，返回error到callback。设为{j:1,w:2,wtimeout:5000}，除了error返回callback，还能保证写操作被提交到日志和至少2个rep中，并且写操作超过5秒就超时\r\n    Strict:true,//默认true，如果要保存的数据中，字段没有在schema中定义，数据将无法保存。也可以设置成throw，如此便抛出错误，而不是仅仅drop数据。\r\n\t//shardKey:{f1:1,f2:1}\t\t//为collection设置shardKey（每个schema不同）\r\n\t//toJSON,\t\t//类似toObject，除了还可以使用JSON.stringify(doc)\r\n\t//toObject,\r\n    validateBeforeSave:mongoSetting.schemaOptions.validateBeforeSaveFlag,\t\t//true: 在保存（save or update）数据到DB的时候自动调用validate方法进行验证（包括mongoose内定和用户自定义validator）并保存；false:需要手工调用validate方法进行验证（内定和自定义），并且可以保存不合格数据（即需要自己做数据验证来决定是否可以保存；不做自定义验证的话，任何数据都可以保存了）\r\n\t//versionKey,\t\t//（**不要设成false除非你知道自己在干啥**）。 设置version key的名称，默认是__v,可以生成任意字符串。\r\n\t//skipVersion,\t\t//**不要设置除非你知道自己在干啥**\r\n\t//timestamps:{createAt:'cDate',updateAt:'uDate'},\t\t//mongoose为schema包含createAt和updateAt字段，当然名字可以自己设定。但是可能需要手工填充日期时间。所以还是直接在schema中显示设置对应field，并为field设置default，以便可以自动填充日期\r\n\t//useNestedStrict:\t//当false的时候，使用schema顶层的strict设置；true的时候，使用sub-document的strict设置\r\n};\r\n//convert mongodb data to objet, so that nodejs can manipulate directly\r\nvar toObjectOptions={\r\n    getters:true,//apply all getters (path and virtual getters)\r\n    virtuals:true,//apply virtual getters (can override getters option)\r\n    minimize:true,// remove empty objects (defaults to true)\r\n    depopulate:false,//如果有外键，直接使用外键而不是外键对应的记录(defaults to false)\r\n    versionKey:false,//whether to include the version key (defaults to true)        //not include version key in result\r\n    retainKeyOrder:false // keep the order of object keys. If this is set to true, Object.keys(new Doc({ a: 1, b: 2}).toObject()) will always produce ['a', 'b'] (defaults to false)\r\n}\r\n\r\n\r\n/*\r\n* schema definition\r\n* 内置validator的定义放在ruleDefine中\r\n* required(all)/min_max(number)/enum_match_minLength_maxLength()\r\n* */\r\n\r\n/*                           department                        */\r\nlet fieldDefine={\r\n    user:{\r\n        name:{type:String,unique:true},\r\n        salt:{type:String},\r\n        encryptedPassword:{type:String},\r\n        cDate:{type:Date,default:Date.now},\r\n        uDate:{type:Date,default:Date.now},\r\n        dDate:{type:Date},\r\n    },\r\n    department:{//采用和inputRule一样的名字，以便之后用for循环添加内置validator\r\n        name:{type:String,unique:true},//全部设成{}，即使只有type定义，以便之后添加validator\r\n        parentDepartment:{type:mongoose.Schema.Types.ObjectId,ref:\"departments\"},\r\n        cDate:{type:Date,default:Date.now},\r\n        uDate:{type:Date,default:Date.now},\r\n        dDate:{type:Date},\r\n    },\r\n    employee:{\r\n        name:{type:String},\r\n        leader:{type:mongoose.Schema.Types.ObjectId,ref:\"employees\"},\r\n        gender:{type:String},\r\n        birthDay:{type:Date},\r\n        department:{type:mongoose.Schema.Types.ObjectId,ref:\"departments\"},\r\n        onBoardDate:{type:Date},\r\n        cDate:{type:Date,default:Date.now},\r\n        uDate:{type:Date,default:Date.now},\r\n        dDate:{type:Date},\r\n    },\r\n    billType:{\r\n        name:{type:String,unique:true},\r\n        parentBillType:{type:mongoose.Schema.Types.ObjectId,ref:\"billTypes\"},\r\n        cDate:{type:Date,default:Date.now},\r\n        uDate:{type:Date,default:Date.now},\r\n        dDate:{type:Date},\r\n    },\r\n    bill: {\r\n        title:{type:String},\r\n        content:{type:String},\r\n        billType:{type:mongoose.Schema.Types.ObjectId,ref:\"billTypes\"},\r\n        billDate:{type:Date},\r\n        amount:{type:Number},\r\n        reimburser:{type:mongoose.Schema.Types.ObjectId,ref:\"employees\"},\r\n        cDate:{type:Date,default:Date.now},\r\n        uDate:{type:Date,default:Date.now},\r\n        dDate:{type:Date},\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n/*\r\n* 根据define/validateRule/validateRule的rule设置schema的rule\r\n* */\r\n//validateInput中的rule，在mongoose中对应的validator\r\nlet ruleMatch={\r\n    require:'required',\r\n    min:'min',\r\n    max:'max',\r\n    minLength:'minlength',\r\n    maxLength:'maxlength',\r\n    format:'match',\r\n    'enum':'enum',\r\n}\r\n//console.log(fieldDefine['department']['parentDepartment'])\r\n/*                          将inputRule中的rule定义转换成mongoose内置validator                          */\r\n//根据flag确实是否要为field设置内建validator\r\nif(true===mongoSetting.schemaOptions.validateFlag){\r\n    for(let singleCollectionsName in fieldDefine){//读取每个collection\r\n        for(let singleFiled in fieldDefine[singleCollectionsName]){//读取每个collection下的字段（path）\r\n            for(let singleItem in inputRule[singleCollectionsName][singleFiled]){//读取每个字段下对应在inputRule下的每个rule\r\n                if(ruleMatch[singleItem]){//rule是否在mongo中有对应的内建validator\r\n                    let singleRuleValue=inputRule[singleCollectionsName][singleFiled][singleItem]\r\n\r\n                    //如果define是format，且value为ObjectID，则无需在mongo上设置对应的内建validator（因为type为objectId的字段会自动判断输入值是否为objectId,er无需添加额外的validator）\r\n                    if('format'===singleItem){\r\n                        if(regex.objectId===singleRuleValue['define']){\r\n                            continue\r\n                        }\r\n                    }\r\n\r\n                    if(false!==singleRuleValue['define']) {//一般而言，有define就可以判断为有validator，但是require比较特殊，只有true才认为有对应的定义\r\n                        if(fieldDefine[singleCollectionsName][singleFiled]){//对应的field在mongo中有定义，则为此field添加validator\r\n                            fieldDefine[singleCollectionsName][singleFiled][ruleMatch[singleItem]]=[]\r\n                            fieldDefine[singleCollectionsName][singleFiled][ruleMatch[singleItem]].push(singleRuleValue['define'])\r\n                            //fieldDefine[singleCollectionsName][singleFiled][ruleMatch[singleItem]].push(singleRuleValue['mongoError'])\r\n                            let errorMsg=`错误代码${singleRuleValue['mongoError']['rc']}:${singleRuleValue['mongoError']['msg']}`\r\n                            fieldDefine[singleCollectionsName][singleFiled][ruleMatch[singleItem]].push(errorMsg)//只能接受字符串\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// fs.writeFile('mongodb.txt',JSON.stringify(fieldDefine))\r\n// console.log(fieldDefine['department']['name'])\r\n//console.log(fieldDefine['employee']['gender']['enum'])\r\n//console.log(JSON.stringify(fieldDefine['billType']))\r\n\r\nvar userSchema=new mongoose.Schema(\r\n    fieldDefine['user'],\r\n    schemaOptions\r\n)\r\n\r\nvar departmentSchema=new mongoose.Schema(\r\n    fieldDefine['department'],\r\n    schemaOptions\r\n)\r\n\r\nvar employeeSchema=new mongoose.Schema(\r\n    fieldDefine['employee'],\r\n    schemaOptions\r\n)\r\nvar billTypeSchema=new mongoose.Schema(\r\n    fieldDefine['billType'],\r\n    schemaOptions\r\n)\r\n\r\nvar billSchema=new mongoose.Schema(\r\n    fieldDefine['bill'],\r\n    schemaOptions\r\n)\r\n\r\nvar userModel=dbFinance.model('users',userSchema)\r\nvar departmentModel=dbFinance.model('departments',departmentSchema)\r\nvar employeeModel=dbFinance.model('employees',employeeSchema)\r\nvar billTypeModel=dbFinance.model('billTypes',billTypeSchema)\r\nvar billModel=dbFinance.model('bills',billSchema)\r\n\r\n//console.log(billModel)\r\nmodule.exports={\r\n    userModel,\r\n    departmentModel,\r\n    employeeModel,\r\n    billTypeModel,\r\n    billModel,\r\n    //以下export，为了mongoValidate\r\n    collections:collections,\r\n    fieldDefine,\r\n} //\r\n\r\n"]}